#!/bin/sh
# dynamic variables and helper functions
if [ -z $SCRIPT_PATH ]; then SCRIPT_PATH=$(dirname $0); fi
. $SCRIPT_PATH/serval-vars

RHIZOME_STORE_PATH=`servald config paths | tail -n-1 | cut -d":" -f2`
SID=`servald id self | sed -n 3p`

if ! [ -e SEVERAL_ALL_SIDS_FILE ]; then
    servald id allpeers | tail -n+3 > $SEVERAL_ALL_SIDS_FILE
fi

date_ms() {
    date +%s%N | cut -b1-13
}

sleep_until_next_ms() {
    MS=$1
    NOW=$(date_ms)
    SLEEP_S=$(bc <<< "scale=3; ($((MS - (NOW % MS)))) / 1000")
    # echo "Sleeping ${SLEEP_S}s"
    sleep $SLEEP_S
}

if [ "$1" = "-h" ]; then
    echo "usage: $0 [ -h | --dump ]"
    echo "defines dynamic variables and helper functions used in serval-tests"
    exit 0
fi

if [ "$1" = "--dump" ]; then
    echo RHIZOME_STORE_PATH=$RHIZOME_STORE_PATH
    echo SID=$SID
    echo SEVERAL_ALL_SIDS_FILE=$SEVERAL_ALL_SIDS_FILE:
    cat $SEVERAL_ALL_SIDS_FILE
fi